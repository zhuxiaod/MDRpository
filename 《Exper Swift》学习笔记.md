# ã€ŠExper Swiftã€‹å­¦ä¹ ç¬”è®°



## å­¦ä¹ çš„è½¬å˜

æœ€è¿‘äº†è§£åˆ°è¿˜æœ‰ä¸€ä¸ªç½‘ç«™å«[raywenderlich](https://www.raywenderlich.com/)ï¼Œè¿›å»ä¸€çœ‹å…¨è‹±æ–‡ç›´æ¥å‚»çœ¼ã€‚ä¹‹å‰æœ‰ä¸€ç§æƒ³æ³•æ˜¯è¿™æ ·çš„ï¼Œç¨‹åºå‘˜ä¸å¿…å­¦è‹±æ–‡ï¼Œå› ä¸ºå‰é¢ä¼šæœ‰ä¼˜ç§€çš„ç¨‹åºå‘˜ç¿»è¯‘æ€»ç»“ç»™æˆ‘ä»¬ï¼Œæˆ‘ä»¬åªè¦è·Ÿéšå¤§ç¥å°±è¡Œäº†ã€‚ä½†æ˜¯è¿™æ ·æƒ³çš„è¯ä¸€ä¸‹å°±ç¼©å°äº†è‡ªå·±çš„å­¦ä¹ èŒƒå›´ï¼Œæ„å‘³ç€åªèƒ½çœ‹å¤§ç¥ç¿»è¯‘çš„ä¸œè¥¿äº†ã€‚æœ‰ä¸€æ¬¡æˆ‘è¦å­¦ä¹ å…³äºé™æ€åº“å¼€å‘ï¼Œæ‰¾äº†å¾ˆå¤šä¸­æ–‡çš„å†…å®¹ï¼Œéƒ½æ˜¯æ€ä¹ˆå®ç°ï¼Œä½†æ˜¯ä¸€ä¸ªæ•´ä½“çš„å¼€å‘æµç¨‹è¿˜æ˜¯æ²¡æœ‰çš„ã€‚ç„¶ååœ¨è¿™ä¸ªç½‘ç«™ä¸­æ‰¾åˆ°äº†ä¸€ç¯‡æ–‡ç« ï¼Œå‘ç°æœ‰åŸç†ï¼Œæœ‰æµç¨‹ï¼Œè¿˜æœ‰ä¸€äº›ä¼˜ç§€çš„å°è£…ï¼Œdemoã€‚å¦‚æœè¿™ä¸ªç½‘ç«™æœ‰çš„è¯ï¼Œæˆ‘ä¼šä¼˜å…ˆçœ‹è¿™ä¸ªç½‘ç«™çš„ã€‚ä½†æ˜¯è‹±æ–‡æ˜¯ä¸ªé—®é¢˜ï¼Œå› ä¸ºæœ‰å¾ˆå¤šç¼–ç¨‹çš„ä¸“ä¸šåè¯ï¼Œç¿»è¯‘è½¯ä»¶ä¸ä¸€å®šèƒ½ç¿»è¯‘å‡ºæ¥ï¼Œæˆ‘å¼€å§‹æ˜¯ä¸çœ‹ç¿»è¯‘ï¼Œä¸€ä¸ªå•è¯ä¸€ä¸ªå•è¯è‡ªå·±ç¿»è¯‘å‡ºæ¥çš„ï¼Œä½†æ˜¯è¿™æ ·å®åœ¨æ˜¯å¤ªæ…¢äº†ï¼Œåˆ°ç°åœ¨åªèƒ½ç”¨ä¸€ä¸ªå·æ‡’çš„æ–¹æ³•ï¼Œåªæœ‰ä¸“ä¸šåè¯çš„æ—¶å€™ï¼Œé‚£ä¸€æ®µè‡ªå·±ç¿»è¯‘ã€‚è¿™æ ·æ˜¯èƒ½æé«˜ä¸€äº›é€Ÿåº¦ï¼Œä½†æ˜¯ç†è§£å¯èƒ½ä¹Ÿä¼šå·®ç‚¹ã€‚è‹±æ–‡ä¸å¥½ï¼Œç®€å•çš„å†…å®¹ç¿»è¯‘è¿‡æ¥ä¹Ÿå¾ˆæ‡µã€‚è¿™æ ·å°±å‡ºç°ä¸€ä¸ªå¾ªç¯ï¼Œæƒ³è®©ç¼–ç¨‹è¿›æ­¥å°±è¦çœ‹ä¸€äº›è‹±æ–‡æ–‡ç« ï¼Œä½†æ˜¯è‹±æ–‡å·®é€Ÿåº¦åˆå¤ªæ…¢äº†ï¼Œä¸è¿‡æ…¢æ…¢æ¥å§ã€‚ä¹Ÿç»™åŒiOSå­¦ä¹ è€…æ¨èè¿™ä¸ªç½‘ç«™å§ã€‚



## ç®€ä»‹

è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘å­¦ä¹ [raywenderlich](https://www.raywenderlich.com/) ä¸­çš„ä¸€æœ¬ä¹¦ã€ŠExper Swiftã€‹ï¼Œè¿™æœ¬ä¹¦æˆ‘ç›®å‰åªçœ‹äº†ä¸€ç‚¹ï¼Œç»™æˆ‘çš„æ„Ÿè§‰æ˜¯æ¯”è¾ƒç»†è‡´çš„è®²Swiftçš„åŸºç¡€çŸ¥è¯†ã€‚æˆ‘å°†è§‰å¾—é‡è¦çš„è®°å¿†ç‚¹è®°å½•ä¸‹æ¥ï¼Œæ–¹ä¾¿ä»¥åè‡ªå·±å»æŸ¥æ‰¾ï¼Œä¸æ˜¯ä¸“ä¸šçš„æ–‡ç« ã€‚ä½†æ˜¯å¦‚æœæœ‰æƒ³ä¸€èµ·çœ‹çš„ä¼™ä¼´ä¹Ÿå¯ä»¥çœ‹ä¸€ä¸‹ã€‚æä¸€äº›å»ºè®®ç»™æˆ‘ä¹Ÿè¡Œï¼Œæœ‰äººäº¤æµçš„å­¦çš„è¯ï¼Œå¯èƒ½æ›´åŠ åŠªåŠ›ç‚¹ã€‚



## Swift ç¼–è¯‘å™¨

Swift ç¼–è¯‘å™¨è´Ÿè´£å°†æºä»£ç è½¬æ¢æˆå¯ä»¥é“¾æ¥åˆ°çš„å¯æ‰§è¡Œæ–‡ä»¶çš„ç›®æ ‡ä»£ç ã€‚å®ƒè¿è¡Œåœ¨LLVMç¼–è¯‘å™¨ä¹‹ä¸­ï¼Œæ•°æ®æµå¦‚ä¸‹ï¼š


```mermaid
graph TD
A(*.swift) --> B[Parse]
    B --> C(Abstract Syntax Tree AST \ æŠ½è±¡è¯­æ³•æ ‘)
    C --> D[Semantic Analysis]
    D --> E[SILGen]
    E --> F(Swift Intermediate Language SIL)
		F --> G[IRGen]
		G --> H(Intermediate Language)
    H --> I[LLVM]
	  I --> J(*.o)
    K[The Swift toolchain pipeline]
```

åƒSwift è¿™æ ·çš„é«˜çº§è¯­è¨€è½¬æ¢æˆæœºå™¨ä»£ç å¹¶ä¸”é«˜æ•ˆçš„åœ¨è®¾å¤‡ä¸Šè¿è¡Œï¼Œè¿™ä¸ªè¿‡ç¨‹å«åš `lowering` ã€‚ä¸Šå›¾åœ†è§’çŸ©å½¢ä»£è¡¨è¾“å…¥æˆ–è¾“å‡ºçš„æ•°æ®ã€‚ä»é«˜åˆ°ä½çš„æ¯ä¸€ä¸ªæ­¥éª¤éƒ½å€¼å¾—ç†è§£ï¼š

1. **Parse**:  Swift æºä»£ç æ˜¯è¦å…ˆè§£æä¸ºæ ‡è®°ï¼Œç„¶åæ”¾å…¥ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ä¸­ã€‚ä½ å¯ä»¥ç†è§£ä¸ºä¸€æ£µæ ‘ï¼Œå…¶ä¸­çš„æ¯ä¸ªè¡¨è¾¾å¼éƒ½æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ã€‚ç„¶åèŠ‚ç‚¹è¿˜ä¿å­˜äº†æºçš„ä½ç½®ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ£€æµ‹åˆ°é”™è¯¯çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨å¯ä»¥å‘Šè¯‰æˆ‘ä»¬é”™è¯¯çš„ä½ç½®ã€‚

2. **Semantic Analysis**ï¼šåœ¨è¿™ä¸ªæ­¥éª¤é‡Œï¼Œç¼–è¯‘å™¨ä½¿ç”¨äº†ASTå»åˆ†æé¡¹ç›®ä»£ç çš„æ„æ€ã€‚è¿™ä¸ªæ­¥éª¤ä¹Ÿæ˜¯è¿›è¡Œ **type checking** ï¼ˆç±»å‹æ£€æŸ¥ï¼‰çš„åœ°æ–¹ã€‚æ£€æŸ¥åå°†ASTä¼ é€’åˆ° **SILGen** é˜¶æ®µã€‚

3. **SILGen**ï¼šå’Œä»¥å‰ä¸ä¸€æ ·ä¸éœ€è¦ç»è¿‡**Clang** è¿™ä¸€æ­¥ã€‚AST è½¬åŒ–æˆ**Swift Intermediate Language**ï¼ˆSwift ä¸­é—´è¯­è¨€ï¼‰ã€‚**SIL** åŒ…å«äº†è®¡ç®—çš„ **basic blocks** (è®¡ç®—å—) å’Œç†è§£ Swift ç±»å‹ï¼Œå‚è€ƒè®¡æ•°å’Œæ´¾å‘ï¼ˆdispatchï¼‰çš„è§„èŒƒã€‚SILè¿˜åŒ…å«æºä½ç½®ä¿¡æ¯ï¼Œå› æ­¤å®ƒå¯ä»¥äº§ç”Ÿæœ‰æ„ä¹‰çš„é”™è¯¯ã€‚

   è¿™ä¸€æ®µå¯¹æˆ‘è‹±æ–‡æ¥è¯´æ˜¯ä¸ªæŒ‘æˆ˜ï¼Œè´´åŸæ–‡ï¼š

   This phase departs from previous compiler pipelines such as **Clang**, which didnâ€™t have this step. The AST gets lowered into **Swift Intermediate Language** (**SIL**). SIL contains **basic blocks** of computation and understands Swift Types, reference counting and dispatch rules. There are two flavors of SIL: raw and canonical. Canonical SIL results from raw SIL run through a minimum set of optimization passes (even when all optimizations are turned off). SIL also contains source location information so it can produce meaningful errors.

4. **IRGen**ï¼š è¿™ä¸€æ­¥è®© **SIL** å˜æˆäº† LLVMçš„ä¸­é—´è¯­è¨€ã€‚è¿™æ—¶å€™æŒ‡ä»¤ä¸å†æ˜¯SwiftæŒ‡ä»¤ã€‚ä½†IR ä»ç„¶ååˆ†æŠ½è±¡ã€‚ä¾‹å¦‚ **SIL**ï¼Œ**IR** æ˜¯é™æ€çš„å•ä¸€å£°æ˜å½¢å¼ã€‚å®ƒæ¨¡æ‹Ÿäº†æ— é™æ•°é‡çš„å¯„å­˜å™¨ï¼Œè®©å®ƒå®¹æ˜“å»å‘ç°ä¼˜åŒ–ã€‚å®ƒä¸çŸ¥é“ä»»ä½•å…³äºSwiftçš„ç±»å‹ã€‚*è¿™é‡Œä¹Ÿå¾ˆä¸æ‡‚ï¼Œç„¶åç†è§£å…·ä½“æ„æ€æ˜¯ï¼ŒåŸæœ¬çš„SwiftæŒ‡ä»¤å·²ç»è¢«è½¬æ¢ã€‚*

5. **LLVM**ï¼šæœ€åä¸€æ­¥ï¼Œä¼˜åŒ–IRï¼Œå’Œè½¬æ¢ä¸ºä¸åŒå¹³å°çš„æœºå™¨æŒ‡ä»¤ã€‚åŒ…æ‹¬ARMã€x86ç­‰ã€‚

ä¸Šé¢çš„è¿‡ç¨‹æ˜¯ï¼ŒSwiftç¼–è¯‘å™¨å¦‚ä½•ç”Ÿæˆç›®æ ‡ä»£ç çš„è¿‡ç¨‹ã€‚



## Definite initialization æ¸…æ™°çš„åˆå§‹åŒ–

Swift æ˜¯ä¸€ç§å®‰å…¨çš„è¯­è¨€ï¼Œé»˜è®¤æƒ…å†µä¸‹å¾ˆéš¾è®¿é—®æœªåˆå§‹åŒ–çš„å†…å­˜ã€‚SILGen é€šè¿‡ä¸€ä¸ªç§°ä¸ºç¡®å®šåˆå§‹åŒ–çš„æ£€æŸ¥è¿‡ç¨‹æä¾›ä¿è¯ã€‚è€ƒè™‘ä¸€ä¸‹è¿™ä¸ªä¾‹å­:

```swift
final class Printer {
  var value: Int
  init(value: Int) { self.value = value }
  func print() { Swift.print(value) }
}

func printTest() {
  var printer: Printer
  if .random() {
    printer = Printer(value: 1)
  }
  else {
    printer = Printer(value: 2)
  }
  printer.print()
}

printTest()
```

è¿™æ®µä»£ç ç¼–è¯‘å¹¶è¿è¡Œè‰¯å¥½ã€‚ä½†æ˜¯å¦‚æœæ³¨é‡Šæ‰ `else` å­å¥ï¼Œåˆ™ç”±äº SILï¼Œç¼–è¯‘å™¨å°†æ­£ç¡®æ ‡è®°ä¸€ä¸ªé”™è¯¯(åˆå§‹åŒ–å‰ä½¿ç”¨çš„å˜é‡â€˜ printerâ€™)ã€‚è¿™ä¸ªé”™è¯¯æ˜¯å¯èƒ½çš„ï¼Œå› ä¸º SIL ç†è§£å¯¹ `Printer` çš„æ–¹æ³•è°ƒç”¨çš„è¯­ä¹‰ã€‚å¦‚æœ`if` ä¸è¢«æ‰§è¡Œï¼Œé‚£ä¹ˆ`printer` æ˜¯å±é™©çš„ã€‚



## Allocation and devirtualization åˆ†é…ä¸è™šæ‹ŸåŒ–

SILGen å¸®åŠ©ä¼˜åŒ–åˆ†é…å’Œæ–¹æ³•è°ƒç”¨ã€‚

çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```swift
class Magic {
    func number() -> Int { return 0 }
}

final class SpecialMagic: Magic {
    override func number() -> Int { return 42 }
}

public var number: Int = -1

func magicTest() {
    //42
    let specialMagic = SpecialMagic()
    //å®é™…ç±»å‹ è¿˜æ˜¯SpecialMagic
    let magic: Magic = specialMagic
    //42
    number = magic.number()
}

magicTest()
```

åœ¨ `magicTest` å‡½æ•°ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª `SpecialMagic` ç±»å‹ï¼Œç„¶ååˆåˆ›å»ºä¸€ä¸ªåŸºç±»å¼•ç”¨ï¼Œè°ƒç”¨`number()`è®¾ç½®`number`ã€‚å®ƒä½¿ç”¨<u>ç±»çš„è™šè¡¨</u>æŸ¥æ‰¾æ­£ç¡®çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›å€¼42ã€‚



## Raw SIL åŸå§‹SIL

å°†ä¸Šé¢çš„ä»£ç æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå°†æ–‡ä»¶å–åä¸º`magic.swift` , ç„¶ååœ¨**terminal** æ‰§è¡Œï¼š

```
swiftc -O -emit-silgen magic.swift > magic.rawsil
```

å°±å¯ä»¥å¾—åˆ°ç¼–è¯‘å™¨ä¼˜åŒ–å’Œåˆ›å»ºçš„åŸå§‹SILï¼Œè¾“å‡ºæ–‡ä»¶ä¸ºmagic.rawsilã€‚

æ‰“å¼€magic.rawsil å°±å¯ä»¥å‘ä¸‹æ»šåŠ¨ï¼Œä¼šå‘ç°magicTest()å‡½æ•°çš„å®šä¹‰ï¼š

```
// magicTest()
sil hidden [ossa] @$s5magic0A4TestyyF : $@convention(thin) () -> () {
bb0:
  %0 = global_addr @$s5magic6numberSivp : $*Int   // user: %14
  %1 = metatype $@thick SpecialMagic.Type         // user: %3
  // function_ref SpecialMagic.__allocating_init()
  %2 = function_ref @$s5magic12SpecialMagicCACycfC : $@convention(method) (@thick SpecialMagic.Type) -> @owned SpecialMagic // user: %3
  %3 = apply %2(%1) : $@convention(method) (@thick SpecialMagic.Type) -> @owned SpecialMagic // users: %18, %5, %4
  debug_value %3 : $SpecialMagic, let, name "specialMagic" // id: %4
  %5 = begin_borrow %3 : $SpecialMagic            // users: %9, %6
  %6 = copy_value %5 : $SpecialMagic              // user: %7
  %7 = upcast %6 : $SpecialMagic to $Magic        // users: %17, %10, %8
  debug_value %7 : $Magic, let, name "magic"      // id: %8
  end_borrow %5 : $SpecialMagic                   // id: %9
  %10 = begin_borrow %7 : $Magic                  // users: %13, %12, %11
  %11 = class_method %10 : $Magic, #Magic.number : (Magic) -> () -> Int, $@convention(method) (@guaranteed Magic) -> Int // user: %12
  %12 = apply %11(%10) : $@convention(method) (@guaranteed Magic) -> Int // user: %15
  end_borrow %10 : $Magic                         // id: %13
  %14 = begin_access [modify] [dynamic] %0 : $*Int // users: %16, %15
  assign %12 to %14 : $*Int                       // id: %15
  end_access %14 : $*Int                          // id: %16
  destroy_value %7 : $Magic                       // id: %17
  destroy_value %3 : $SpecialMagic                // id: %18
  %19 = tuple ()                                  // user: %20
  return %19 : $()                                // id: %20
} // end sil function '$s5magic0A4TestyyF'
```

ä¸Šé¢çš„ä»£ç æ˜¯ä¸‰è¡Œå‡½æ•° magicTest()çš„SILå®šä¹‰ã€‚Label bb0ä»£è¡¨åŸºæœ¬å—0ï¼Œæ˜¯è®¡ç®—å•å…ƒã€‚% 1ã€% 2ç­‰å€¼æ˜¯è™šæ‹Ÿå¯„å­˜å™¨ã€‚SIL æ˜¯åœ¨å•ä¸€é™æ€åˆ†é…å½¢å¼ï¼Œæ‰€ä»¥å¯„å­˜å™¨æ˜¯æ— é™çš„ï¼Œä»æ¥æ²¡æœ‰é‡ç”¨ã€‚ç»†èŠ‚å¹¶ä¸é‡è¦ï¼Œå¤§å®¶å¯ä»¥å¤§è‡´äº†è§£ä¸€ä¸‹ç¼–è¯‘å™¨å¦‚ä½•åˆ†é…ã€å£°æ˜ã€è°ƒç”¨å’Œé‡Šæ”¾å¯¹è±¡çš„ã€‚



## Canonical SIL

æ¥ä¸‹æ¥ï¼Œè¿è¡Œ`Terminal` å‘½ä»¤ï¼š

```
swiftc -O -emit-sil magic.swift > magic.sil
```

è¾“å‡ºæ–‡ä»¶ï¼š`magic.SIL` , æŸ¥çœ‹åº•éƒ¨ magicTest():

```
// magicTest()
sil hidden @$s5magic0A4TestyyF : $@convention(thin) () -> () {
bb0:
  %0 = global_addr @$s5magic6numberSivp : $*Int   // user: %3
  %1 = integer_literal $Builtin.Int64, 42         // user: %2
  %2 = struct $Int (%1 : $Builtin.Int64)          // user: %4
  %3 = begin_access [modify] [dynamic] [no_nested_conflict] %0 : $*Int // users: %4, %5
  store %2 to %3 : $*Int                          // id: %4
  end_access %3 : $*Int                           // id: %5
  %6 = tuple ()                                   // user: %7
  return %6 : $()                                 // id: %7
} // end sil function '$s5magic0A4TestyyF'
```

è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä»£ç å°‘äº†å¾ˆå¤šã€‚ä½†æ˜¯å†…å®¹å´æ˜¯ç›¸åŒçš„ã€‚ä¸»è¦å·¥ä½œæ˜¯å°†æ•´æ•°æ–‡å­—42å­˜å‚¨åˆ°å…¨å±€åœ°å€ä½ç½®å­˜å‚¨åŒº% 2åˆ°% 3: $* Intã€‚æ²¡æœ‰åˆå§‹åŒ–æˆ–å–æ¶ˆåˆå§‹åŒ–ç±»ï¼Œä¹Ÿæ²¡æœ‰è°ƒç”¨ä»»ä½•è™šæ–¹æ³•ã€‚ä½†è¿™é‡Œåªæ˜¯ä¸€ç§æ¦‚æ‹¬ã€‚

åœ¨ Swift ä¸­ï¼Œæ‰€æœ‰å†…å®¹éƒ½ä»å †ä¸Šåˆå§‹åŒ–å¼€å§‹ï¼ŒSIL åˆ†æå¯ä»¥å°†åˆ†é…ç§»åˆ°å †æ ˆä¸­ï¼Œç”šè‡³å®Œå…¨åˆ é™¤å®ƒã€‚è™šå‡½æ•°è°ƒç”¨ä¹Ÿå¯ä»¥é€šè¿‡ä¼˜åŒ–è¿‡ç¨‹è¿›è¡Œéè™šæ‹ŸåŒ–ï¼Œç›´æ¥è°ƒç”¨ç”šè‡³å†…è”è°ƒç”¨ã€‚



## Building ifelse

ä¸‹æ¥è·Ÿä¹¦ä¸€èµ·å­¦ä¹ å®ç°ä¸€ä¸ªifelse() è¯­å¥ã€‚

è¿™ä¸ªå‡½æ•°çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š

```
ifelse(condition, valueTrue, valueFalse)
```

æœ‰ç‚¹ç±»ä¼¼ä¸‰ç›®è¿ç®—ç¬¦ï¼Œ1.valueTrueï¼švalueFalseã€‚

```swift
func ifelse(condition: Bool,
            valueTrue: Int,
            valueFalse: Int) -> Int {
    if condition {
        return valueTrue
    } else {
        return valueFalse
    }
}
let value = ifelse(condition: Bool.random(),
                   valueTrue: 100,
                   valueFalse: 0)
```

è¿™ä¸ªå‡½æ•°å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œç”¨æˆ·åªèƒ½ä½¿ç”¨Intï¼Œéœ€è¦å»åšä¸€ç‚¹æ”¹è¿›ï¼Œè®©æ›´å¤šçš„äººè§‰å¾—å¥½ç”¨ï¼š

```swift
func ifelse(_ condition: Bool, 
            _ valueTrue: Int, 
            _ valueFalse: Int) -> Int {
  condition ? valueTrue : valueFalse
}

let value = ifelse(.random(), 100, 0)
```

å¯¹äºç»å¸¸ä½¿ç”¨çš„è¯­è¨€æ„é€ ï¼Œå»æ‰å‚æ•°æ ‡ç­¾æ˜¯æœ‰æ„ä¹‰çš„ã€‚

```swift
func ifelse(_ condition: Bool, 
            _ valueTrue: Int, 
            _ valueFalse: Int) -> Int {
  condition ? valueTrue : valueFalse
}
func ifelse(_ condition: Bool, 
            _ valueTrue: String, 
            _ valueFalse: String) -> String {
  condition ? valueTrue : valueFalse
}
func ifelse(_ condition: Bool, 
            _ valueTrue: Double, 
            _ valueFalse: Double) -> Double {
  condition ? valueTrue : valueFalse
}
func ifelse(_ condition: Bool, 
            _ valueTrue: [Int], 
            _ valueFalse: [Int]) -> [Int] {
  condition ? valueTrue : valueFalse
}	
```

å¦‚æœæƒ³è®©æ›´å¤šç±»å‹ä½¿ç”¨ï¼Œå°±éœ€è¦é‡è½½æ›´å¤šã€‚

ä½†æ˜¯è¿™æ ·å°±è¦å†™æ›´å¤šçš„æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™ä½ ä¹Ÿè®¸ä¼šè§‰å¾—ä½¿ç”¨ `Any` ,å¯ä»¥è§£å†³ã€‚

```swift
func ifelse(_ condition: Bool,
            _ valueTrue: Any,
            _ valueFalse: Any) -> Any {
  condition ? valueTrue : valueFalse
}

let value = ifelse(.random(), 100, 0) as! Int
```

```swift
let value = ifelse(.random(), "100", 0) as! Int
```

ä½†æ˜¯å¿…éœ€å›æº¯åˆ°æ‰€éœ€çš„åŸå§‹ç±»å‹ã€‚å¦‚æœç±»å‹ä¸åŒï¼Œé‚£ä¹ˆåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å®¹æ˜“å´©æºƒã€‚

```swift
func ifelse<V>(_ condition: Bool,
               _ valueTrue: V,
               _ valueFalse: V) -> V {
  condition ? valueTrue : valueFalse
}

// let value = ifelse(.random(), "100", 0)  // doesnâ€™t compile anymore
let value = ifelse(.random(), 100, 0)
```

ä½¿ç”¨æ³›å‹æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚æ—¢ä¿ç•™äº†ç±»å‹ä¿¡æ¯ï¼Œåˆçº¦æŸå‚æ•°ä¸è¿”å›ç±»å‹ç›¸åŒã€‚



## Deferring execution æ¨è¿Ÿæ‰§è¡Œ

```swift
func expensiveValue1() -> Int {
  print("side-effect-1")
  return 2
}

func expensiveValue2() -> Int {
  print("side-effect-2")
  return 1729
}

let taxicab = ifelse(.random(), 
                     expensiveValue1(), 
                     expensiveValue2())
```

è¿™æ ·å†™çœ‹èµ·æ¥å¾ˆç®€ä¾¿ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å®Œæˆï¼š

å½“æˆ‘ä»¬è¿™æ ·è¿è¡Œçš„è¯ï¼Œ2ä¸ªæ–¹æ³•éƒ½ä¼šè¢«è¿è¡Œï¼Œå½“ç„¶æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœæ˜¯åªæ‰§è¡Œä¸€ä¸ªç»“æœã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªé—­åŒ…å»è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

```swift
func ifelse<V>(_ condition: Bool,
               _ valueTrue: () -> V,
               _ valueFalse: () -> V) -> V {
  condition ? valueTrue() : valueFalse()
}
```

```swift
func expensiveValue1() -> Int {
  print("side-effect-1")
  return 2
}

func expensiveValue2() -> Int {
  print("side-effect-2")
  return 1729
}

let taxicab = ifelse(.random(),
                     { expensiveValue1() },
                     { expensiveValue2() })
print(taxicab)
```

æ·»åŠ é—­åŒ…ä»¥åï¼Œç¡®å®åªæ‰§è¡Œäº†ä¸€ä¸ªè¡¨è¾¾å¼ã€‚ä½†æ˜¯æˆ‘ä»¬çš„å†™æ³•å˜çš„å¥‡æ€ªèµ·æ¥ã€‚ä½†æœ‰è¶£çš„æ˜¯ï¼ŒSwiftå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

```swift
func ifelse<V>(_ condition: Bool,
               _ valueTrue: @autoclosure () -> V,
               _ valueFalse: @autoclosure () -> V) -> V {
  condition ? valueTrue() : valueFalse()
}

let value = ifelse(.random(), 100, 0 )

let taxicab = ifelse(.random(),
                     expensiveValue1(),
                     expensiveValue2())
```

ç”¨@autoclosure è£…é¥°å‚æ•°ç±»å‹ä¼šå¯¼è‡´ç¼–è¯‘å™¨è‡ªåŠ¨å°†å‚æ•°åŒ…è£…åˆ°é—­åŒ…ä¸­ã€‚æ­¤æ›´æ”¹å°†è°ƒç”¨ç«™ç‚¹æ¢å¤ä¸ºåŸæ¥çš„çŠ¶æ€ï¼Œå¹¶ä¸”ä»ç„¶å»¶è¿Ÿæ‰§è¡Œï¼Œå› æ­¤åªæœ‰ä½¿ç”¨çš„å‚æ•°è®¡ç®—ç»“æœã€‚



## Using expressions that can fail ä½¿ç”¨å¯èƒ½å¤±è´¥çš„è¡¨è¾¾å¼

å¦‚æœæƒ³ä½¿ç”¨å¤±è´¥çš„è¡¨è¾¾å¼æ€ä¹ˆåŠï¼Ÿ

```swift
func expensiveFailingValue1() throws -> Int {
  print("side-effect-1")
  return 2
}

func expensiveFailingValue2() throws -> Int {
  print("side-effect-2")
  return 1729
}

let failableTaxicab = ifelse(.random(),
                             try expensiveFailingValue1(),
                             try expensiveFailingValue2())
```

è¿™æ ·å°†æ— æ³•ç¼–è¯‘ï¼Œå› ä¸º`autoclosures` ä¸èƒ½æŒ‡æœ›ä¼šæŠ›å‡ºé—­åŒ…ã€‚å¦‚æœæ²¡æœ‰ç¼–è¯‘å™¨çš„å¸®åŠ©ï¼Œä½ å¯èƒ½ä¼šæƒ³åˆ°åˆ›å»ºå¦ä¸€ä¸ªå‡½æ•°æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

```Swift
func ifelseThrows<V>(_ condition: Bool,
               _ valueTrue: @autoclosure () throws -> V,
               _ valueFalse: @autoclosure () throws -> V) throws -> V {
  condition ? try valueTrue() : try valueFalse()
}

let taxicab2 = try ifelseThrows(.random(),
                                try expensiveFailingValue1(),
                                try expensiveFailingValue2())
```

è¿™ä¸ªä»£ç å¯ä»¥å®Œæˆå·¥ä½œï¼Œä½†æ˜¯éå¸¸çš„ä¸‘ã€‚ã€‚ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·æ¥å†™ï¼š

```swift
func ifelse<V>(_ condition: Bool,
               _ valueTrue: @autoclosure () throws -> V,
               _ valueFalse: @autoclosure () throws -> V) rethrows -> V {
  condition ? try valueTrue() : try valueFalse()
}
```

çœ‹ä¸€ä¸‹ `rethrows`ã€‚å¦‚æœé—­åŒ…å¤±è´¥ï¼Œé”™è¯¯ä¼šç»™è°ƒç”¨æ–¹ã€‚è€Œä¸”ä¸ç”¨ä½¿ç”¨ tryã€‚

çœ‹ä¸€ä¸‹å˜å½¢è¿‡ç¨‹ï¼š

```swift
let value = ifelse(.random(), 100, 0 )
let taxicab = ifelse(.random(),
                     expensiveValue1(),
                     expensiveValue2())                     
let taxicab2 = try ifelse(.random(),
                          try expensiveFailingValue1(),
                          try expensiveFailingValue2())
let taxicab3 = try ifelse(.random(),
                           expensiveValue1(),
                           try expensiveFailingValue2())
let taxicab4 = try ifelse(.random(),
                          try expensiveFailingValue1(),
                          expensiveValue2())
```

æ·»åŠ  `@inlinable` å…³é”®å­—ï¼Œå¯ä»¥è®©æ–¹æ³•çš„å†…å®¹ç›´æ¥åŒ…å«åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ï¼Œè€Œä¸éœ€è¦è°ƒç”¨å‡½æ•°çš„å¼€é”€ã€‚



## Performance

ä¸‹é¢ä¼˜åŒ–ç¼–è¯‘ï¼š

```swift
@inlinable
func ifelse<V>(_ condition: Bool,
               _ valueTrue: @autoclosure () throws -> V,
               _ valueFalse: @autoclosure () throws -> V) rethrows -> V {
  condition ? try valueTrue() : try valueFalse()
}

func ifelseTest1() -> Int {
  if .random() {
      return 100
  } else {
      return 200
  }
}

func ifelseTest2() -> Int {
  Bool.random() ? 300 : 400
}

func ifelseTest3() -> Int {
  ifelse(.random(), 500, 600)
}
```

æ”¾å…¥ä¸€ä¸ªå«åš ifelse.swiftçš„æ–‡æœ¬æ–‡ä»¶ä¸­ã€‚

åœ¨`Terminal` è¿è¡Œï¼š

```
 swiftc -O -emit-assembly ifelse.swift > ifelse.asm
```

å†åšä¸€æ¬¡æ·±å‘¼å¸ï¼Œæ‰“å¼€æ±‡ç¼–æ–‡ä»¶ã€‚ğŸ˜‚

æ±‡ç¼–æ–‡ä»¶åŒ…å«å¤§é‡è°ƒç”¨çº¦å®šå’Œå…¥å£ç‚¹çš„æ ·æ¿æ–‡ä»¶ã€‚ä¸è¦å› ä¸ºè¿™ä¸ªå°±æ”¾å¼ƒå¯»æ‰¾ã€‚åˆ é™¤ä¸éœ€è¦çš„ä¸œè¥¿ï¼Œçœ‹è¿™é‡Œï¼š

```swift
_$s6ifelse0A5Test1SiyF:
    :
    callq   _swift_stdlib_random
    testl   $131072, -8(%rbp)
    movl    $100, %ecx
    movl    $200, %eax
    cmoveq  %rcx, %rax
    :

_$s6ifelse0A5Test2SiyF:
    :
    callq   _swift_stdlib_random
    testl   $131072, -8(%rbp)
    movl    $300, %ecx
    movl    $400, %eax
    cmoveq  %rcx, %rax
    :

_$s6ifelse0A5Test3SiyF:    
    :    
    callq   _swift_stdlib_random
    testl   $131072, -8(%rbp)
    movl    $500, %ecx
    movl    $600, %eax
    cmoveq  %rcx, %rax
    :
```

è¿™äº›æ˜¯ä¸‰ä¸ªæµ‹è¯•å‡½æ•°çš„æ±‡ç¼–æŒ‡ä»¤ã€‚ifelseTest1()ã€ ifelseTest2()å’Œ ifelseTest3()çš„å®ç°ï¼Œéƒ½å·®ä¸å¤šä¸€æ ·ï¼Œä¹Ÿååˆ†ç®€å•ã€‚

æ¥ä¸‹æ¥è®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹æ±‡ç¼–å§~ã€‚

`callq` æŒ‡ä»¤è°ƒç”¨å‡½æ•°è·å–ä¸€ä¸ªéšæœºæ•°ã€‚ 

`testl` æŒ‡ä»¤è·å–éšæœºæ•°è¿”å›å€¼ã€‚(ä½äº64ä½åŸºæŒ‡é’ˆ -8æŒ‡å‘çš„åœ°å€)ã€‚å®ƒå°†å…¶ä¸131072è¿›è¡Œæ¯”å¯¹ï¼Œ131072æ˜¯0x20000æˆ–ç¬¬17ä½ã€‚æƒŠå¥‡çš„å‘ç°ï¼š

```swift
@inlinable
public static func random<T: RandomNumberGenerator>(
  using generator: inout T
) -> Bool {
  return (generator.next() >> 17) & 1 == 0
}
```

æ¯”å¯¹äº†å°±èƒ½çŸ¥é“Boolçš„çœŸå‡äº†ã€‚



## Key points

* Swift æ˜¯ä¸€ç§å¤šèŒƒå¼è¯­è¨€ï¼Œæ”¯æŒè®¸å¤šç¼–ç¨‹é£æ ¼ï¼ŒåŒ…æ‹¬å‘½ä»¤å¼ã€å‡½æ•°å¼ã€é¢å‘å¯¹è±¡ã€é¢å‘åè®®å’Œé€šç”¨èŒƒå¼ã€‚
* åœ¨Swift ä¸­æœªå®šä¹‰è¡Œä¸ºå¾ˆéš¾è§¦å‘ã€‚
* Swift åªæœ‰å½“ä½ çœŸæ­£éœ€è¦çš„æ—¶å€™æ‰ä¼šå»å­¦ä¹ æ›´é«˜çº§çš„è¯­è¨€ç‰¹æ€§ã€‚
* Swiftæ˜¯ä¸€ä¸ªæœ‰å¼ºå¤§ç±»å‹ç³»ç»Ÿå’Œç±»å‹æ¨ç†åŠŸèƒ½çš„ç¼–ç¨‹è¯­è¨€ã€‚
* Swiftçš„å¤§éƒ¨åˆ†å®šä¹‰åœ¨è¡¨è¾¾å¼å’Œæ ‡å‡†åº“ä¸­ï¼Œè€Œä¸æ˜¯ç¼–è¯‘å™¨ä¸­ã€‚
* Swift ç¼–è¯‘è¿‡ç¨‹ï¼šè§£æã€è¯­ä¹‰åˆ†æã€SILGenã€IRGen å’Œ LLVMã€‚
* æºä½ç½®ä¿¡æ¯åœ¨ASTå’ŒSILä¸­ï¼Œæœ‰æ›´å¥½çš„é”™è¯¯æŠ¥å‘Šã€‚
* SILæ”¯æŒæ˜ç¡®çš„åˆå§‹åŒ–ï¼Œå†…å­˜åˆ†é…ä¼˜åŒ–å’Œå»è™šæ‹ŸåŒ–ã€‚
* ä¼˜å…ˆä½¿ç”¨æ³›å‹ï¼Œåœ¨æ»¡è¶³ä¸äº†éœ€æ±‚çš„æƒ…å†µä¸‹å†å»ä½¿ç”¨`Any` ã€‚
* å°†é—­åŒ…ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œè¯¥å‚æ•°è¿”å›ä¸€ä¸ªå€¼ï¼Œä»¥ä¾¿å°†å‚æ•°çš„è®¡ç®—æ¨è¿Ÿåˆ°å‡½æ•°ä½“å†…ã€‚
* `@autoclosure` å¯ä»¥ä¸å†™é—­åŒ…çš„æ‹¬å·ï¼Œå› ä¸ºå®ƒä¹Ÿæ¨è¿Ÿäº†è¡¨è¾¾å¼å‚æ•°çš„æ‰§è¡Œã€‚
* `@inlinable` å‘ŠçŸ¥ç¼–è¯‘å™¨ï¼Œå‡½æ•°çš„æ‰§è¡Œå‘é€åˆ°è°ƒç”¨ç«™ã€‚
* ç¼–è¯‘å™¨æ¶ˆé™¤äº†å¾ˆå¤š(å¦‚æœä¸æ˜¯æ‰€æœ‰çš„)æºä»£ç çš„æŠ½è±¡æˆæœ¬ã€‚
* æŠ½è±¡åº”è¯¥ä¸ºè‡ªå·±ä»˜å‡ºä»£ä»·ã€‚åœ¨åˆ›é€ æ–°çš„è¯­è¨€ç‰¹æ€§ä¹‹å‰å¥½å¥½è€ƒè™‘ä¸€ä¸‹ã€‚



## å¼•ç”¨

ã€ŠExper Swiftã€‹









